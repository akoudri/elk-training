input {
  beats {
    port => 5044
  }

  tcp {
    port => 5000
    codec => json
  }

  http {
    port => 8080
    codec => json
  }
}

filter {
  # Process Nginx logs
  if [log_type] == "nginx" or "nginx" in [tags] {
    # Parse nginx access logs using grok pattern
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      add_tag => [ "nginx_parsed" ]
      tag_on_failure => [ "_grokparsefailure_nginx" ]
    }

    # If grok was successful, enrich with additional data
    if "_grokparsefailure_nginx" not in [tags] {
      # Parse the timestamp from the log
      date {
        match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        target => "@timestamp"
      }

      # Convert response code to integer
      mutate {
        convert => {
          "response" => "integer"
          "bytes" => "integer"
        }
      }

      # Add GeoIP information based on client IP
      geoip {
        source => "clientip"
        target => "geoip"
        add_tag => [ "geoip" ]
      }

      # Add tag for 404 errors (not found)
      if [response] == 404 {
        mutate {
          add_tag => [ "not_found" ]
          add_field => { "error_type" => "not_found" }
        }
      }

      # Add tag for 5xx errors (server errors)
      if [response] >= 500 {
        mutate {
          add_tag => [ "server_error" ]
        }
      }

      # Add tag for 4xx errors (client errors)
      if [response] >= 400 and [response] < 500 {
        mutate {
          add_tag => [ "client_error" ]
        }
      }

      # Parse the user agent
      useragent {
        source => "agent"
        target => "user_agent"
      }

      # Extract URL path
      if [request] {
        grok {
          match => { "request" => "%{WORD:http_method} %{URIPATHPARAM:url_path} HTTP/%{NUMBER:http_version}" }
        }
      }

      # Set index prefix for nginx logs
      mutate {
        add_field => { "[@metadata][index_prefix]" => "nginx-logs" }
        remove_field => [ "timestamp" ]
      }
    }
  }
  # Process syslog messages
  else if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGLINE}" }
    }
    date {
      match => [ "timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
    mutate {
      add_field => { "[@metadata][index_prefix]" => "syslog" }
    }
  }
  # Default index for other logs
  else {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "logstash" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://es01:9200", "http://es02:9200", "http://es03:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
  }

  # Uncomment for debugging
  # stdout {
  #   codec => rubydebug
  # }
}
